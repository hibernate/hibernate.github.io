<!DOCTYPE html> <html lang="en"> <head> <title>Running hibernate.org within Docker - Hibernate</title> <meta charset="utf-8"> <meta content="width=device-width, initial-scale=1.0" name="viewport"> <meta content="" name="description"> <meta content="" name="author"> <link href="http://static.jboss.org/theme/css/bootstrap-community/2.3.1.3/bootstrap-community.min.css" media="screen" rel="stylesheet"> <link href="../../stylesheets/styles.css" media="screen" rel="stylesheet"> <!--[if lt IE 9]><script src="http://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script><![endif]--> <link href="http://static.jboss.org/images/hibernate/favicon.ico" rel="shortcut icon"> <link href="http://static.jboss.org/images/hibernate/apple-touch-icon-144x144-precomposed.png" rel="apple-touch-icon-precomposed" sizes="144x144"> <link href="http://static.jboss.org/images/hibernate/apple-touch-icon-114x114-precomposed.png" rel="apple-touch-icon-precomposed" sizes="114x114"> <link href="http://static.jboss.org/images/hibernate/apple-touch-icon-72x72-precomposed.png" rel="apple-touch-icon-precomposed" sizes="72x72"> <link href="http://static.jboss.org/images/hibernate/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed"> <style>
      @media (min-width: 980px) {
        .banner { background-image: url(http://static.jboss.org/images/hibernate/hibernate-banner-1180px.png); height: 110px;  }
      }
      @media (max-width: 979px) {
        .banner { background-image: url(http://static.jboss.org/images/hibernate/hibernate-logo.png); background-repeat:no-repeat; height: 60px; }
      }
      @media (max-width: 650px) {
        .banner { width: 200px; margin: 0px auto; }
      }
    </style> <script src="http://static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.min.js"></script> </head> <body> <div id="subproject"> <ul class="visuallyhidden" id="top"> <li> <a accesskey="n" href="#nav" title="Skip to navigation">Skip to navigation</a> </li> <li> <a accesskey="c" href="#page" title="Skip to content">Skip to content</a> </li> </ul> <div class="container" id="content"> <div id="logobar"> <div class="dropup"> <a class="tabnav-closed" href="https://www.jboss.org" id="tab">Red Hat</a> <script>
              window.addEventListener('load', function() { renderTabzilla("Hibernate","hibernate") }, false);
            </script> </div> <a href="/"> <img src="http://static.jboss.org/hibernate/images/hibernate_logo_whitebkg_200px.png"> </a> </div> <div class="navbar navbar-inverse"> <div class="navbar-inner"> <a class="btn btn-navbar" data-target=".nav-collapse" data-toggle="collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </a> <div class="nav-collapse collapse"> <ul class="nav pull-left"> <li class=""><a href="/orm/">ORM</a></li> <li class=""><a href="/search/">Search</a></li> <li class=""><a href="/validator/">Validator</a></li> <li class=""><a href="/ogm/">OGM</a></li> <li class=""><a href="/tools/">Tools</a></li> <li class=""><a href="/others/">Others</a></li> </ul> <ul class="nav pull-right"> <li><a href="http://in.relation.to">Blog</a></li> <li class=""><a href="../../community">Community</a></li> <li class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="#">Follow Us <b class="caret"></b></a> <ul class="dropdown-menu projectsocialmedia"> <li><a href="https://twitter.com/hibernate"><img src="http://static.jboss.org/theme/images/common/socialmedia_icon40_twitter.png"></a></li> <li><a href="https://plus.google.com/112681342290762837955/posts"><img src="http://static.jboss.org/theme/images/common/socialmedia_icon40_googleplus.png"></a></li> </ul> </li> </ul> </div> </div> </div> <div class="visible-desktop"> <h1>Running hibernate.org within Docker</h1> </div> <div class="hidden-desktop"> <h1 class="text-center">Running hibernate.org within Docker</h1> </div> <div class="row-fluid"> <div class="span12"> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p>The following instructions allow you to run hibernate.org within a docker container while still being able to edit your sources locally. This is not a Docker introduction. At least you will need a running Docker daemon. If you want an intro into Docker - <a href="http://docs.docker.com/">start here</a>.</p> </div> </div> <div id="toc" class="toc"> <div id="toctitle">Table of Contents</div> <ul class="sectlevel1"> <li><a href="#the-short-version">The short version</a></li> <li><a href="#the-long-version">The long version</a> <ul class="sectlevel2"> <li><a href="#building-the-docker-image">Building the Docker image</a></li> <li><a href="#running-the-container">Running the container</a></li> </ul> </li> </ul> </div> </div> <div class="sect1"> <h2 id="the-short-version"><a class="anchor" href="#the-short-version"></a>The short version</h2> <div class="sectionbody"> <div class="paragraph"> <p>The short version. If you are lucky all you need is:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code>&gt; cd docker&#x000A;&gt; docker build -t hibernate/hibernate.org .&#x000A;&gt; docker run -t -i -p 4242:4242 -v `pwd | xargs dirname`:/home/dev/hibernate.org hibernate/hibernate.org</code></pre> </div> </div> <div class="paragraph"> <p>Once you have a bash into the running container you can use the various Rake task to drive awestruct.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="paragraph"> <p>The first time you use the Docker approach make sure that you don&#8217;t have any changes in your local checkout of hibernate.org, in particular temp files generated by Bundler. You can for example run <code>git clean -fxd</code>, but make sure you have no outstanding changes.</p> </div> </td> </tr> </table> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="fa icon-tip" title="Tip"></i> </td> <td class="content"> <div class="paragraph"> <p>On Linux you might need to use <em>sudo</em> to execute docker commands. If you want to avoid that have a look at <a href="https://docs.docker.com/installation/ubuntulinux/#create-a-docker-group">create a docker group</a>.</p> </div> </td> </tr> </table> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p><code>pwd | xargs dirname</code> tries to determine the full path to the root directory of your hibernate.org checkout. It assumes you are in the <em>docker</em> sub-directory when you execute it. If you replace <code>pwd | xargs dirname</code> with your specific root directory path, you can run this command from anywhere.</p> </div> </td> </tr> </table> </div> </div> </div> <div class="sect1"> <h2 id="the-long-version"><a class="anchor" href="#the-long-version"></a>The long version</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="building-the-docker-image"><a class="anchor" href="#building-the-docker-image"></a>Building the Docker image</h3> <div class="paragraph"> <p>First step is to build the Docker image containing your awestruct setup. This step could eventually be replaced by a automatically build image made available via a Docker repository. For now, however, we build this image locally.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code>&gt; docker build -t hibernate/hibernate.org .</code></pre> </div> </div> <div class="paragraph"> <p>Whenever the gem dependencies change, you will need to rebuild the image to make sure you get a working environment out of the box.</p> </div> <div class="paragraph"> <p>Below you see the used Dockerfile with some comments:</p> </div> <div class="listingblock"> <div class="title">Dockerfile for Awestruct setup based on Fedora 22</div> <div class="content"> <pre class="CodeRay highlight"><code>FROM       fedora:22&#x000A;&#x000A;# install the required dependencies to complile natice extensions&#x000A;RUN        dnf -y install gcc-c++ make ruby-devel libxml2-devel libxslt-devel findutils git ruby <i class="conum" data-value="1"></i><b>(1)</b>&#x000A;&#x000A;RUN        groupadd -r dev &amp;&amp; useradd  -g dev -u 1000 dev <i class="conum" data-value="2"></i><b>(2)</b>&#x000A;RUN        mkdir -p /home/dev&#x000A;RUN        chown dev:dev /home/dev&#x000A;&#x000A;# From here we run everything as dev user&#x000A;USER       dev&#x000A;&#x000A;# Setup all the env variables needed for ruby&#x000A;ENV        HOME /home/dev&#x000A;ENV        GEM_HOME $HOME/.gems&#x000A;ENV        GEM_PATH $HOME/.gems&#x000A;ENV        PATH $PATH:$GEM_HOME/bin&#x000A;ENV        LC_ALL en_US.UTF-8&#x000A;ENV        LANG en_US.UTF-8&#x000A;RUN        mkdir $HOME/.gems&#x000A;&#x000A;# Install Rake and Bundler for driving the Awestruct build &amp; site&#x000A;RUN        gem install -N rake bundler&#x000A;&#x000A;# Clone hibernate.org in order to run the setup task&#x000A;RUN        git clone https://github.com/hibernate/in.relation.to.git <i class="conum" data-value="3"></i><b>(3)</b>&#x000A;RUN        cd $HOME/hibernate.org &amp;&amp; git checkout production &amp;&amp; rake setup&#x000A;&#x000A;# We need to patch awestruct to make auto generation work. On mounted volumes file&#x000A;# change montoring will only work with polling&#x000A;RUN        gem contents awestruct | grep auto.rb | xargs sed -i "s/^\(.*force_polling =\).*/\1 true/" <i class="conum" data-value="4"></i><b>(4)</b>&#x000A;&#x000A;EXPOSE     4242&#x000A;VOLUME     $HOME/hibernate.org&#x000A;WORKDIR    $HOME/hibernate.org&#x000A;&#x000A;CMD [ "/bin/bash" ]</code></pre> </div> </div> <div class="colist arabic"> <table> <tr> <td><i class="conum" data-value="1"></i><b>1</b></td> <td>Install all dependencies, especially the ones needed to compile native extensions. After changes to the gem dependencies this might need to be updated. Otherwise we rely on the default ruby version available via <em>dnf</em>.</td> </tr> <tr> <td><i class="conum" data-value="2"></i><b>2</b></td> <td>In order for the container to be able to modify files in your mounted volume, we need to make sure that the created <em>dev</em> user gets the same user id as the files have on the host machine. In many cases 1000 is a good guess, but in case you are getting file permission errors when running <code>rake preview</code> you want to check which user id the files have when mounted into the container. Use this user id as part of the <code>useradd</code> command and re-build the image.</td> </tr> <tr> <td><i class="conum" data-value="3"></i><b>3</b></td> <td>We need the checkout to setup the awestruct environment. At runtime the checkout will be overridden by the mounted volume</td> </tr> <tr> <td><i class="conum" data-value="4"></i><b>4</b></td> <td>An awestruct hack. Awestruct uses live-reload to determine file changes in order to trigger re-generation of pages. live-reload allows to configure how changes are detected, but awestruct does not expose this option. When mounting your checkout as a volume, the default detection fails (at least on Mac using boot2docker) and polling needs to be used. This sed command will patch the awestruct version we use. Obviously this is very fragile to changes in awestruct version</td> </tr> </table> </div> </div> <div class="sect2"> <h3 id="running-the-container"><a class="anchor" href="#running-the-container"></a>Running the container</h3> <div class="paragraph"> <p>Once you have your image you can run the docker container and use it to drive your awestruct site. The site can be previewed under <a href="http://localhost:4242" class="bare">http://localhost:4242</a> on Linux or <a href="http://&lt;docker-ip&gt;:4242" class="bare">http://&lt;docker-ip&gt;:4242</a> with boot2docker, where <em>docker-ip</em> can be retrieved via <code>boot2docker ip</code>.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay highlight"><code>&gt; docker run -t -i -p 4242:4242 -v &lt;path to root directry of hibernate.org checkout&gt;:/home/dev/hibernate.org hibernate/hibernate.org</code></pre> </div> </div> </div> </div> </div> </div> </div> </div> <footer class="container"> <div class="row-fluid"> <div class="span3 offset2"> <h4>Projects</h4> <ul> <li> <a href="../../orm" title="Hibernate ORM">Hibernate ORM</a> </li> <li> <a href="../../search" title="Search">Hibernate Search</a> </li> <li> <a href="../../validator" title="Hibernate Validator">Hibernate Validator</a> </li> <li> <a href="../../ogm" title="Hibernate OGM">Hibernate OGM</a> </li> <li> <a href="../../tools" title="Hibernate Tools">Hibernate Tools</a> </li> <li> <a href="../../others" title="Other projects">Other projects</a> </li> </ul> </div> <div class="span3"> <h4>Follow Us</h4> <ul> <li> <a href="http://in.relation.to" title="Blog">Blog</a> </li> <li> <a href="https://twitter.com/hibernate/" title="Twitter">Twitter</a> </li> <li> <a href="https://plus.google.com/112681342290762837955/posts" title="Google+">Google+</a> </li> </ul> </div> <div class="span3"> <h4>Contribute and community</h4> <ul> <li> <a href="../../community" title="Community resources">Community resources</a> </li> <li> <a href="https://hibernate.atlassian.net" title="Submit a bug">Submit a bug</a> </li> <li> <a href="https://access.redhat.com/security/team/contact/" title="Report a security issue">Report a security issue</a> </li> </ul> </div> </div> </footer> <div class="container" id="companyfooter"> <div class="row-fluid"> <div class="span6 redhatlogo text-center"> <div id="logospacer"></div> <a href="http://www.redhat.com/"><img src="http://static.jboss.org/theme/images/common/redhat_logo.png"></a> </div> <div class="span6 redhatlogo text-center"> <div id="logospacer"></div> <a href="http://www.jboss.org/"> <img src="http://static.jboss.org/theme/images/common/jbossbadge.png"> </a> </div> </div> </div> <span class="backToTop"> <a href="#top">back to top</a> </span> <script src="../../javascripts/bootstrap-community.min.js"></script> <script>
       (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      
                          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      
                          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      
                          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
       
      ga('create', 'UA-45270411-1', 'auto');
      ga('send', 'pageview');
      
      </script> </div> </body> </html>